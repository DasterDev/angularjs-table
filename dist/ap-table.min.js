"use strict";angular.module("andyperlitch.apTable",["andyperlitch.apTable.templates","ui.sortable","ngSanitize"]).service("tableFilterFunctions",function(){function a(a,b){a=a.toLowerCase().trim(),b=b.toLowerCase();var c=a[0];return"!"===c?(a=a.substr(1),""===a?!0:-1===b.indexOf(a)):"="===c?(a=a.substr(1),a===b.trim()):(a=a.replace("\\!","!"),a=a.replace("\\=","="),-1!==b.indexOf(a))}function b(b,c,d,e){return a(b,d,d,e)}function c(a,b){b=parseFloat(b),a=a.trim();var c=a.substr(0,2),d=a[0],e=1*a.substr(1),f=1*a.substr(2);return"<="===c?f>=b:">="===c?b>=f:"<"===d?e>b:">"===d?b>e:"~"===d?Math.round(b)===e:"="===d?e===b:b.toString().indexOf(a.toString())>-1}function d(a,b,d){return c(a,d)}function e(a){for(var b=a.trim().split(","),c=0,d=0;d<b.length;d++){var e=b[d].trim(),f=h.exec(e);if(f){var i=1*f[1],j=f[2].replace(/s$/,"");g.hasOwnProperty(j)&&(c+=i*g[j])}}return c}function f(a,b){if(a=a.trim(),!a)return!0;b*=1;var c,d,f=new Date,h=+f,i=a[0],j=a.substr(1).trim();if("<"===i)return c=h-e(j),b>c;if(">"===i)return d=h-e(j),d>b;if("today"===a)return new Date(b).toDateString()===f.toDateString();if("yesterday"===a)return new Date(b).toDateString()===new Date(h-g.d).toDateString();var k=new Date(a);return isNaN(k)?!1:new Date(b).toDateString()===k.toDateString()}a.placeholder=b.placeholder="string search",a.title=b.title='Search by text, eg. "foo". Use "!" to exclude and "=" to match exact text, e.g. "!bar" or "=baz".',c.placeholder=d.placeholder="number search",c.title=d.title='Search by number, e.g. "123". Optionally use comparator expressions like ">=10" or "<1000". Use "~" for approx. int values, eg. "~3" will match "3.2"';var g={};g.second=g.sec=g.s=1e3,g.minute=g.min=g.m=60*g.second,g.hour=g.hr=g.h=60*g.minute,g.day=g.d=24*g.hour,g.week=g.wk=g.w=7*g.day,g.month=4*g.week,g.year=g.yr=g.y=365*g.day;var h=/(\d+(?:\.\d+)?)\s*([a-z]+)/;return f.placeholder="date search",f.title='Search by date. Enter a date string (RFC2822 or ISO 8601 date). You can also type "today", "yesterday", "> 2 days ago", "< 1 day 2 hours ago", etc.',{like:a,likeFormatted:b,number:c,numberFormatted:d,date:f}}).service("tableFormatFunctions",function(){function a(){return'<input type="checkbox" ng-checked="selected.indexOf(row) >= 0" ap-table-selector />'}return a.trustAsHtml=!0,{selector:a}}).service("tableSortFunctions",function(){return{number:function(a){return function(b,c){return b[a]-c[a]}},string:function(a){return function(b,c){return b[a].toString().toLowerCase()===c[a].toString().toLowerCase()?0:b[a].toString().toLowerCase()>c[a].toString().toLowerCase()?1:-1}}}}).filter("tableRowFilter",["tableFilterFunctions","$log",function(a,b){return function(c,d,e){var f,g=c;return f=d.filter(function(c){var d=e[c.id];if(e.hasOwnProperty(c.id)&&"string"==typeof d){if(!d.trim())return!1;if("function"==typeof c.filter)return!0;var f=a[c.filter];if("function"==typeof f)return c.filter=f,!0;b.warn('apTable: The filter function "'+c.filter+'" specified by column(id='+c.id+').filter was not found in predefined tableFilterFunctions. Available filters: "'+Object.keys(a).join('","')+'"')}return!1}),f.length&&(g=c.filter(function(a){for(var b=f.length-1;b>=0;b--){var c=f[b],d=c.filter,g=e[c.id],h=a[c.key],i="function"==typeof c.format?c.format(h):h;if(!d(g,h,i,a))return!1}return!0})),g}}]).filter("tableCellFilter",["$sce","$sanitize",function(){return function(a,b){var c=a.hasOwnProperty(b.key);if(!c)return b.defaultValue||"";var d=a[b.key],e=b.format;return"function"==typeof e?e(d,a,b):d}}]).filter("tableRowSorter",function(){function a(a,c){if(b.hasOwnProperty(c))return b[c];for(var d=a.length-1;d>=0;d--)if(a[d].id===c)return b[c]=a[d],a[d]}var b={};return function(b,c,d,e){if(!d.length)return b;for(var f=[],g=0;g<b.length;g++)f.push(b[g]);return f.sort(function(b,f){for(var g=0;g<d.length;g++){var h=d[g],i=a(c,h),j=e[h];if(i&&i.sort){var k=i.sort,l="+"===j?k(b,f):k(f,b);if(0!==l)return l}}return 0})}}).controller("TableController",["$scope","tableFormatFunctions","tableSortFunctions","tableFilterFunctions","$log","$window",function(a,b,c,d,e,f){a.addSort=function(b,c){var d=a.sortOrder.indexOf(b);-1===d&&a.sortOrder.push(b),a.sortDirection[b]=c},a.removeSort=function(b){var c=a.sortOrder.indexOf(b);-1!==c&&a.sortOrder.splice(c,1),delete a.sortDirection[b]},a.clearSort=function(){a.sortOrder=[],a.sortDirection={}},a.hasFilterFields=function(){for(var b=a.columns.length-1;b>=0;b--)if("undefined"!=typeof a.columns[b].filter)return!0;return!1},a.toggleSort=function(b,c){if(c.sort)if(b.shiftKey)switch(a.sortDirection[c.id]){case"+":a.sortDirection[c.id]="-";break;case"-":a.removeSort(c.id);break;default:a.addSort(c.id,"+")}else{var d=a.sortDirection[c.id];a.clearSort(),"+"===d?a.addSort(c.id,"-"):a.addSort(c.id,"+")}},a.getSortClass=function(b){var c=a.options.sort_classes;return"+"===b?c[1]:"-"===b?c[2]:c[0]},a.setColumns=function(f){a.columns=f;var g={format:b,sort:c,filter:d};a.columns.forEach(function(a){angular.forEach(g,function(b,c){var d=a[c];"function"!=typeof d&&("string"==typeof d?"function"==typeof b[d]?a[c]="sort"===c?b[d](a.key):b[d]:(delete a[c],e.warn(c+" function reference in column(id="+a.id+") was not found in built-in "+c+" functions. "+c+' function given: "'+d+'". Available built-ins: '+Object.keys(b).join(","))):delete a[c])})})},a.startColumnResize=function(b,c){function d(a){var b=a.pageX,c=b-g;e=j+c,h.css("width",e+"px")}b.preventDefault(),b.originalEvent.preventDefault(),b.stopPropagation();var e=!1,g=b.pageX,h=$('<div class="column-resizer-marquee"></div>'),i=$(b.target).parent("th");i.append(h);var j=i.outerWidth();h.css({width:j+"px",height:i.outerHeight()+"px"}),$(f).on("mousemove",d),$(f).one("mouseup",function(b){b.stopPropagation(),h.remove(),$(f).off("mousemove",d),e===!1?delete c.width:c.width=Math.max(e,0),a.$apply()})},a.sortableOptions={axis:"x",handle:".column-text"},a.options={sort_classes:["glyphicon glyphicon-sort","glyphicon glyphicon-chevron-up","glyphicon glyphicon-chevron-down"]},a.columns instanceof Array?a.setColumns(a.columns):e.warn('"columns" array not found in apTable scope!'),a.rows instanceof Array||e.warn('"rows" array not found in apTable scope!'),a.searchTerms={},a.sortOrder=[],a.sortDirection={}}]).directive("dtDynamic",function(a){return{restrict:"A",replace:!0,scope:{dynamic:"=dtDynamic",row:"=",column:"=",selected:"="},link:function(b,c){b.$watch("dynamic",function(d){c.html(d),a(c.contents())(b)})}}}).directive("apTableSelector",function(){return{restrict:"A",scope:!1,link:function(a,b){var c=a.selected,d=a.row;b.on("click",function(){var b=c.indexOf(d);b>=0?c.splice(b,1):c.push(d),a.$apply()})}}}).directive("apTable",function(){return{templateUrl:"src/ap-table.tpl.html",restrict:"E",scope:{columns:"=",rows:"=",classes:"@tableClass",selected:"="},controller:"TableController"}}),angular.module("andyperlitch.apTable.templates",["src/ap-table.tpl.html"]),angular.module("src/ap-table.tpl.html",[]).run(["$templateCache",function(a){a.put("src/ap-table.tpl.html",'<table ng-class="classes" class="ap-table">\n  <thead>\n    <tr ui-sortable="sortableOptions" ng-model="columns">\n      <th \n        scope="col" \n        ng-repeat="column in columns" \n        ng-click="toggleSort($event,column)" \n        ng-class="{\'sortable-column\' : column.sort}" \n        ng-attr-title="{{ column.title || \'\' }}"\n        ng-style="{ width: column.width, \'min-width\': column.width, \'max-width\': column.width }"\n      >\n        <span class="column-text">\n          {{column.hasOwnProperty(\'label\') ? column.label : column.id }}\n          <span \n            ng-if="column.sort" \n            title="This column is sortable. Click to toggle sort order. Hold shift while clicking multiple columns to stack sorting."\n            class="sorting-icon {{ getSortClass( sortDirection[column.id] ) }}"\n          ></span>\n        </span>\n        <span \n          ng-if="!column.lock_width"\n          ng-class="{\'discreet-width\': !!column.width, \'column-resizer\': true}"\n          title="Click and drag to set discreet width. Click once to clear discreet width."\n          ng-mousedown="startColumnResize($event, column)"\n        >\n          &nbsp;\n        </span>\n      </th>\n    </tr>\n    <tr ng-if="hasFilterFields()">\n      <th ng-repeat="column in columns">\n        <input \n          type="search"\n          ng-if="(column.filter)"\n          ng-model="searchTerms[column.id]"\n          ng-attr-placeholder="{{ column.filter && column.filter.placeholder }}"\n          ng-attr-title="{{ column.filter && column.filter.title }}"\n        >\n      </th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="row in rows | tableRowFilter:columns:searchTerms | tableRowSorter:columns:sortOrder:sortDirection ">\n      <td ng-repeat="column in columns">\n        <span ng-if="column.format && column.format.trustAsHtml" dt-dynamic="row | tableCellFilter:column" row="row" column="column" selected="selected"></span>\n        <span ng-if="!column.format || !column.format.trustAsHtml" ng-bind="row | tableCellFilter:column"></span>\n      </td>\n    </tr>\n  </tbody>\n</table>')}]);